generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider  = "postgresql"
  extensions = [postgis]
}

model User {
  id             Int             @id @default(autoincrement())
  email          String          @unique
  passwordHash   String          @map("password_hash")
  firstName      String?         @map("first_name")
  lastName       String?         @map("last_name")
  role           UserRole        @default(VIEWER)
  isActive       Boolean         @default(true) @map("is_active")
  lastActiveAt   DateTime?       @map("last_active_at")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  passwordResets PasswordReset[]
  refreshTokens  RefreshToken[]
  sessions       Session[]

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    Int      @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model RefreshToken {
  id        String    @id @default(cuid())
  userId    Int       @map("user_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model PasswordReset {
  id        String    @id @default(cuid())
  userId    Int       @map("user_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_resets")
}

model Customer {
  id                  Int                 @id @default(autoincrement())
  customerReferenceId String              @unique @map("customer_reference_id")
  firstName           String              @map("first_name")
  lastName            String              @map("last_name")
  email               String              @unique
  phoneNumber         String              @map("phone_number")
  accountStatus       AccountStatus       @default(ACTIVE) @map("account_status")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")
  appeals             Appeal[]            @relation("CustomerAppeals")
  violations          CustomerViolation[] @relation("CustomerViolations")
  parkingRequests     ParkingRequest[]    @relation("CustomerRequests")
  tickets             ParkingTicket[]     @relation("CustomerTickets")
  vehicles            Vehicle[]

  @@map("customers")
}

model Staff {
  id                 Int                 @id @default(autoincrement())
  firstName          String              @map("first_name")
  lastName           String              @map("last_name")
  email              String              @unique
  phoneNumber        String              @map("phone_number")
  role               StaffRole
  accountStatus      AccountStatus       @default(ACTIVE) @map("account_status")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  zoneId             Int?                @map("zone_id")
  zone               ParkingZone?        @relation(fields: [zoneId], references: [id])
  reviewedAppeals    Appeal[]            @relation("ReviewerAppeals")
  violationsRecorded CustomerViolation[] @relation("OfficerViolations")
  requestedActions   EnforcementAction[]
  agentTickets       ParkingTicket[]     @relation("AgentTickets")

  @@map("staff")
}

model Vehicle {
  plateNumber     String              @unique @map("plate_number")
  plateCode       String?             @map("plate_code")
  plateSource     String?             @map("plate_source")
  plateType       String?             @map("plate_type")
  isDefault       Boolean             @default(false) @map("is_default")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  customerId      Int                 @map("customer_id")
  id              Int                 @id @default(autoincrement())
  violations      CustomerViolation[]
  parkingRequests ParkingRequest[]
  tickets         ParkingTicket[]
  customer        Customer            @relation(fields: [customerId], references: [id])

  @@map("vehicles")
}

model ParkingZone {
  zoneCode         String                   @unique @map("zone_code")
  zoneName         String                   @map("zone_name")
  geographicalArea Unsupported("geometry")? @map("geographical_area")
  id               Int                      @id @default(autoincrement())
  violations       CustomerViolation[]
  bays             ParkingBay[]
  parkingRequests  ParkingRequest[]
  staff            Staff[]

  @@map("parking_zones")
}

model ParkingBay {
  bayCode         String           @unique @map("bay_code")
  bayName         String           @map("bay_name")
  address         String?
  capacityLanes   Int              @default(0) @map("capacity_lanes")
  baseFee         Decimal          @default(0.00) @map("base_fee") @db.Decimal(10, 2)
  operatingHours  Json?            @map("operating_hours")
  id              Int              @id @default(autoincrement())
  zoneId          Int              @map("zone_id")
  zone            ParkingZone      @relation(fields: [zoneId], references: [id])
  parkingRequests ParkingRequest[]
  slots           ParkingSlot[]
  tickets         ParkingTicket[]

  @@map("parking_bays")
}

model ParkingSlot {
  slotNumber      String           @map("slot_number")
  status          SlotStatus       @default(AVAILABLE)
  sensorId        String?          @map("sensor_id")
  id              Int              @id @default(autoincrement())
  bayId           Int              @map("bay_id")
  parkingRequests ParkingRequest[]
  bay             ParkingBay       @relation(fields: [bayId], references: [id])
  tickets         ParkingTicket[]

  @@map("parking_slots")
}

model ParkingTicket {
  transactionRef String              @unique @map("transaction_ref")
  channel        String              @default("WEB")
  amountPaid     Decimal             @map("amount_paid") @db.Decimal(10, 2)
  durationHours  Int                 @map("duration_hours")
  startTime      DateTime            @map("start_time")
  expiryTime     DateTime            @map("expiry_time")
  checkoutTime   DateTime?           @map("checkout_time")
  status         TicketStatus        @default(ACTIVE)
  paymentMethod  PaymentMethod       @map("payment_method")
  createdAt      DateTime            @default(now()) @map("created_at")
  id             Int                 @id @default(autoincrement())
  customerId     Int                 @map("customer_id")
  vehicleId      Int                 @map("vehicle_id")
  bayId          Int                 @map("bay_id")
  slotId         Int?                @map("slot_id")
  agentId        Int?                @map("agent_id")
  violations     CustomerViolation[]
  agent          Staff?              @relation("AgentTickets", fields: [agentId], references: [id])
  bay            ParkingBay          @relation(fields: [bayId], references: [id])
  customer       Customer            @relation("CustomerTickets", fields: [customerId], references: [id])
  slot           ParkingSlot?        @relation(fields: [slotId], references: [id])
  vehicle        Vehicle             @relation(fields: [vehicleId], references: [id])
  receipts       Receipt[]

  @@map("parking_tickets")
}

model Receipt {
  receiptNumber String        @unique @map("receipt_number")
  generatedAt   DateTime      @default(now()) @map("generated_at")
  pdfUrl        String?       @map("pdf_url")
  id            Int           @id @default(autoincrement())
  ticketId      Int           @map("ticket_id")
  ticket        ParkingTicket @relation(fields: [ticketId], references: [id])

  @@map("receipts")
}

model ViolationType {
  code          String              @unique
  description   String
  defaultFee    Decimal             @map("default_fee") @db.Decimal(10, 2)
  severityLevel Int                 @default(1) @map("severity_level")
  id            Int                 @id @default(autoincrement())
  violations    CustomerViolation[]

  @@map("violation_types")
}

model CustomerViolation {
  referenceId          String              @unique @map("reference_id")
  locationDescription  String?             @map("location_description")
  violationDate        DateTime            @map("violation_date")
  feeAmount            Decimal             @map("fee_amount") @db.Decimal(10, 2)
  status               ViolationStatus     @default(OUTSTANDING)
  evidenceImages       Json?               @map("evidence_images")
  customerId           Int                 @map("customer_id")
  id                   Int                 @id @default(autoincrement())
  ticketId             Int?                @map("ticket_id")
  vehicleId            Int                 @map("vehicle_id")
  violationTypeId      Int                 @map("violation_type_id")
  zoneId               Int                 @map("zone_id")
  enforcementOfficerId Int                 @map("enforcement_officer_id")
  appeals              Appeal[]
  customer             Customer            @relation("CustomerViolations", fields: [customerId], references: [id])
  enforcementOfficer   Staff               @relation("OfficerViolations", fields: [enforcementOfficerId], references: [id])
  ticket               ParkingTicket?      @relation(fields: [ticketId], references: [id])
  vehicle              Vehicle             @relation(fields: [vehicleId], references: [id])
  violationType        ViolationType       @relation(fields: [violationTypeId], references: [id])
  zone                 ParkingZone         @relation(fields: [zoneId], references: [id])
  actions              EnforcementAction[]
  fines                Fine[]

  @@map("customer_violations")
}

model EnforcementAction {
  actionType         ActionType        @map("action_type")
  referenceId        String            @unique @map("reference_id")
  requestedAt        DateTime          @default(now()) @map("requested_at")
  status             ActionStatus      @default(PENDING)
  paymentStatus      PaymentStatus     @default(PENDING) @map("payment_status")
  releaseDate        DateTime?         @map("release_date")
  towingCompany      String?           @map("towing_company")
  impoundLotLocation String?           @map("impound_lot_location")
  id                 Int               @id @default(autoincrement())
  violationId        Int               @map("violation_id")
  requestedBy        Int               @map("requested_by")
  requester          Staff             @relation(fields: [requestedBy], references: [id])
  violation          CustomerViolation @relation(fields: [violationId], references: [id])

  @@map("enforcement_actions")
}

model Fine {
  amount      Decimal           @db.Decimal(10, 2)
  isPaid      Boolean           @default(false) @map("is_paid")
  paymentDate DateTime?         @map("payment_date")
  id          Int               @id @default(autoincrement())
  violationId Int               @map("violation_id")
  violation   CustomerViolation @relation(fields: [violationId], references: [id])

  @@map("fines")
}

model Appeal {
  appealReason String            @map("appeal_reason")
  attachments  Json?
  status       AppealStatus      @default(PENDING)
  reviewNotes  String?           @map("review_notes")
  createdAt    DateTime          @default(now()) @map("created_at")
  customerId   Int               @map("customer_id")
  id           Int               @id @default(autoincrement())
  violationId  Int               @map("violation_id")
  reviewerId   Int?              @map("reviewer_id")
  customer     Customer          @relation("CustomerAppeals", fields: [customerId], references: [id])
  reviewer     Staff?            @relation("ReviewerAppeals", fields: [reviewerId], references: [id])
  violation    CustomerViolation @relation(fields: [violationId], references: [id])

  @@map("appeals")
}

model ParkingRequest {
  id            Int           @id @default(autoincrement())
  customerId    Int           @map("customer_id")
  vehicleId     Int           @map("vehicle_id")
  zoneId        Int?          @map("zone_id")
  bayId         Int?          @map("bay_id")
  slotId        Int?          @map("slot_id")
  startTime     DateTime      @map("start_time")
  durationHours Int           @map("duration_hours")
  status        RequestStatus @default(PENDING)
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  bay           ParkingBay?   @relation(fields: [bayId], references: [id])
  customer      Customer      @relation("CustomerRequests", fields: [customerId], references: [id])
  slot          ParkingSlot?  @relation(fields: [slotId], references: [id])
  vehicle       Vehicle       @relation(fields: [vehicleId], references: [id])
  zone          ParkingZone?  @relation(fields: [zoneId], references: [id])

  @@map("parking_requests")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model spatial_ref_sys {
  srid      Int     @id
  auth_name String? @db.VarChar(256)
  auth_srid Int?
  srtext    String? @db.VarChar(2048)
  proj4text String? @db.VarChar(2048)
}

enum StaffRole {
  ADMIN
  PARKING_AGENT
  ENFORCEMENT_AGENT
}

enum UserRole {
  ADMIN
  ENFORCEMENT_OFFICER
  ANALYST
  VIEWER
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
}

enum SlotStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  OUT_OF_SERVICE
}

enum TicketStatus {
  ACTIVE
  COMPLETED
  EXPIRED
  CANCELLED
}

enum PaymentMethod {
  WALLET
  CARD
  CASH
  AIRTIME
}

enum ViolationStatus {
  OUTSTANDING
  PAID
  APPEALED
  WAIVED
}

enum ActionType {
  CLAMP
  TOW
  IMPOUND
}

enum ActionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  RELEASED
}

enum PaymentStatus {
  PENDING
  PAID
}

enum AppealStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
  CANCELLED
}
