generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [postgis]
}

// Enums
enum StaffRole {
  ADMIN
  PARKING_AGENT
  ENFORCEMENT_AGENT
}

enum UserRole {
  ADMIN
  ENFORCEMENT_OFFICER
  ANALYST
  VIEWER
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
}

enum SlotStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  OUT_OF_SERVICE
}

enum TicketStatus {
  ACTIVE
  COMPLETED
  EXPIRED
  CANCELLED
}

enum PaymentMethod {
  WALLET
  CARD
  CASH
  AIRTIME
}

enum ViolationStatus {
  OUTSTANDING
  PAID
  APPEALED
  WAIVED
}

enum ActionType {
  CLAMP
  TOW
  IMPOUND
}

enum ActionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  RELEASED
}

enum PaymentStatus {
  PENDING
  PAID
}

enum AppealStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
  CANCELLED
}

// Authentication & User Management
model User {
  id              Int       @id @default(autoincrement())
  email           String    @unique
  passwordHash    String    @map("password_hash")
  firstName       String?   @map("first_name")
  lastName        String?   @map("last_name")
  role            UserRole  @default(VIEWER)
  isActive        Boolean   @default(true) @map("is_active")
  lastActiveAt    DateTime? @map("last_active_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relationships
  sessions        Session[]
  refreshTokens   RefreshToken[]
  passwordResets  PasswordReset[]

  @@map("users")
}

model Session {
  id           String    @id @default(cuid())
  userId       Int       @map("user_id")
  token        String    @unique @db.Text
  expiresAt    DateTime  @map("expires_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  
  // Relationships
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model RefreshToken {
  id           String    @id @default(cuid())
  userId       Int       @map("user_id")
  token        String    @unique @db.Text
  expiresAt    DateTime  @map("expires_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  revokedAt    DateTime? @map("revoked_at")
  
  // Relationships
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model PasswordReset {
  id        String    @id @default(cuid())
  userId    Int       @map("user_id")
  token     String    @unique @db.Text
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  // Relationships
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_resets")
}

// Identity & Access Management
model Customer {
  id                  Int           @id @default(autoincrement())
  customerReferenceId String        @unique @map("customer_reference_id")
  firstName           String        @map("first_name")
  lastName            String        @map("last_name")
  email               String        @unique
  phoneNumber         String        @map("phone_number")
  accountStatus       AccountStatus @default(ACTIVE) @map("account_status")
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")

  // Relationships
  vehicles            Vehicle[]
  tickets             ParkingTicket[] @relation("CustomerTickets")
  violations          CustomerViolation[] @relation("CustomerViolations")
  appeals             Appeal[]            @relation("CustomerAppeals")
  parkingRequests     ParkingRequest[]    @relation("CustomerRequests")

  @@map("customers")
}

model Staff {
  id              Int           @id @default(autoincrement())
  firstName       String        @map("first_name")
  lastName        String        @map("last_name")
  email           String        @unique
  phoneNumber     String        @map("phone_number")
  role            StaffRole
  accountStatus   AccountStatus @default(ACTIVE) @map("account_status")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relationships
  agentTickets        ParkingTicket[] @relation("AgentTickets")
  violationsRecorded  CustomerViolation[] @relation("OfficerViolations")
  requestedActions    EnforcementAction[]
  reviewedAppeals     Appeal[]            @relation("ReviewerAppeals")

  @@map("staff")
}

model Vehicle {
  id          Int      @id @default(autoincrement())
  customerId  Int      @map("customer_id")
  plateNumber String   @unique @map("plate_number")
  plateCode   String?  @map("plate_code") // e.g., "KJA"
  plateSource String?  @map("plate_source") // e.g., "Lagos"
  plateType   String?  @map("plate_type") // e.g., "Private"
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relationships
  customer   Customer             @relation(fields: [customerId], references: [id])
  tickets    ParkingTicket[]
  violations      CustomerViolation[]
  parkingRequests ParkingRequest[]

  @@map("vehicles")
}

// Parking Infrastructure
model ParkingZone {
  id               Int                                      @id @default(autoincrement())
  zoneCode         String                                   @unique @map("zone_code")
  zoneName         String                                   @map("zone_name")
  geographicalArea Unsupported("geometry(Polygon, 4326)")? @map("geographical_area")

  // Relationships
  bays       ParkingBay[]
  violations      CustomerViolation[]
  parkingRequests ParkingRequest[]

  @@map("parking_zones")
}

model ParkingBay {
  id             Int      @id @default(autoincrement())
  zoneId         Int      @map("zone_id")
  bayCode        String   @unique @map("bay_code")
  bayName        String   @map("bay_name")
  address        String?  @db.Text
  capacityLanes  Int      @default(0) @map("capacity_lanes")
  baseFee        Decimal  @default(0.00) @map("base_fee") @db.Decimal(10, 2)
  operatingHours Json?    @map("operating_hours")

  // Relationships
  zone    ParkingZone     @relation(fields: [zoneId], references: [id])
  slots   ParkingSlot[]
  tickets         ParkingTicket[]
  parkingRequests ParkingRequest[]

  @@map("parking_bays")
}

model ParkingSlot {
  id         Int        @id @default(autoincrement())
  bayId      Int        @map("bay_id")
  slotNumber String     @map("slot_number")
  status     SlotStatus @default(AVAILABLE)
  sensorId   String?    @map("sensor_id")

  // Relationships
  bay     ParkingBay      @relation(fields: [bayId], references: [id])
  tickets         ParkingTicket[]
  parkingRequests ParkingRequest[]

  @@map("parking_slots")
}

// Parking Transactions & Tickets
model ParkingTicket {
  id            Int           @id @default(autoincrement())
  transactionRef String       @unique @map("transaction_ref")
  customerId    Int           @map("customer_id")
  vehicleId     Int           @map("vehicle_id")
  bayId         Int           @map("bay_id")
  slotId        Int?          @map("slot_id")
  agentId       Int?          @map("agent_id")
  channel       String        @default("WEB") // Can be enum if strict
  amountPaid    Decimal       @map("amount_paid") @db.Decimal(10, 2)
  durationHours Int           @map("duration_hours")
  startTime     DateTime      @map("start_time")
  expiryTime    DateTime      @map("expiry_time")
  checkoutTime  DateTime?     @map("checkout_time")
  status        TicketStatus  @default(ACTIVE)
  paymentMethod PaymentMethod @map("payment_method")
  createdAt     DateTime      @default(now()) @map("created_at")

  // Relationships
  customer    Customer           @relation("CustomerTickets", fields: [customerId], references: [id])
  vehicle     Vehicle            @relation(fields: [vehicleId], references: [id])
  bay         ParkingBay         @relation(fields: [bayId], references: [id])
  slot        ParkingSlot?       @relation(fields: [slotId], references: [id])
  agent       Staff?             @relation("AgentTickets", fields: [agentId], references: [id])
  receipts    Receipt[]
  violations  CustomerViolation[] // If related to overstay

  @@map("parking_tickets")
}

model Receipt {
  id            Int      @id @default(autoincrement())
  ticketId      Int      @map("ticket_id")
  receiptNumber String   @unique @map("receipt_number")
  generatedAt   DateTime @default(now()) @map("generated_at")
  pdfUrl        String?  @map("pdf_url")

  // Relationships
  ticket ParkingTicket @relation(fields: [ticketId], references: [id])

  @@map("receipts")
}

// Enforcement & Violations
model ViolationType {
  id            Int     @id @default(autoincrement())
  code          String  @unique
  description   String  @db.Text
  defaultFee    Decimal @map("default_fee") @db.Decimal(10, 2)
  severityLevel Int     @default(1) @map("severity_level")

  // Relationships
  violations CustomerViolation[]

  @@map("violation_types")
}

model CustomerViolation {
  id                  Int             @id @default(autoincrement())
  referenceId         String          @unique @map("reference_id")
  ticketId            Int?            @map("ticket_id")
  customerId          Int             @map("customer_id")
  vehicleId           Int             @map("vehicle_id")
  violationTypeId     Int             @map("violation_type_id")
  zoneId              Int             @map("zone_id")
  locationDescription String?         @map("location_description") @db.Text
  violationDate       DateTime        @map("violation_date")
  feeAmount           Decimal         @map("fee_amount") @db.Decimal(10, 2)
  status              ViolationStatus @default(OUTSTANDING)
  enforcementOfficerId Int            @map("enforcement_officer_id")
  evidenceImages      Json?           @map("evidence_images") // Array of URLs

  // Relationships
  ticket             ParkingTicket?      @relation(fields: [ticketId], references: [id])
  customer           Customer            @relation("CustomerViolations", fields: [customerId], references: [id])
  vehicle            Vehicle             @relation(fields: [vehicleId], references: [id])
  violationType      ViolationType       @relation(fields: [violationTypeId], references: [id])
  zone               ParkingZone         @relation(fields: [zoneId], references: [id])
  enforcementOfficer Staff               @relation("OfficerViolations", fields: [enforcementOfficerId], references: [id])
  actions            EnforcementAction[]
  fines              Fine[]
  appeals            Appeal[]

  @@map("customer_violations")
}

model EnforcementAction {
  id                Int           @id @default(autoincrement())
  violationId       Int           @map("violation_id")
  actionType        ActionType    @map("action_type")
  referenceId       String       @unique @map("reference_id")
  requestedBy       Int           @map("requested_by")
  requestedAt       DateTime      @default(now()) @map("requested_at")
  status            ActionStatus  @default(PENDING)
  paymentStatus     PaymentStatus @default(PENDING) @map("payment_status")
  releaseDate       DateTime?     @map("release_date")
  towingCompany     String?       @map("towing_company")
  impoundLotLocation String?      @map("impound_lot_location")

  // Relationships
  violation   CustomerViolation @relation(fields: [violationId], references: [id])
  requester   Staff             @relation(fields: [requestedBy], references: [id])

  @@map("enforcement_actions")
}

model Fine {
  id          Int      @id @default(autoincrement())
  violationId Int      @map("violation_id")
  amount      Decimal  @db.Decimal(10, 2)
  isPaid      Boolean  @default(false) @map("is_paid")
  paymentDate DateTime? @map("payment_date")

  // Relationships
  violation CustomerViolation @relation(fields: [violationId], references: [id])

  @@map("fines")
}

model Appeal {
  id           Int          @id @default(autoincrement())
  violationId  Int          @map("violation_id")
  customerId   Int          @map("customer_id")
  appealReason String       @map("appeal_reason") @db.Text
  attachments  Json? // Array of URLs
  status       AppealStatus @default(PENDING)
  reviewerId   Int?         @map("reviewer_id")
  reviewNotes  String?      @map("review_notes") @db.Text
  createdAt    DateTime     @default(now()) @map("created_at")

  // Relationships
  violation CustomerViolation @relation(fields: [violationId], references: [id])
  customer  Customer          @relation("CustomerAppeals", fields: [customerId], references: [id])
  reviewer  Staff?            @relation("ReviewerAppeals", fields: [reviewerId], references: [id])

  @@map("appeals")
}

model ParkingRequest {
  id            Int           @id @default(autoincrement())
  customerId    Int           @map("customer_id")
  vehicleId     Int           @map("vehicle_id")
  zoneId        Int?          @map("zone_id")
  bayId         Int?          @map("bay_id")
  slotId        Int?          @map("slot_id")
  startTime     DateTime      @map("start_time")
  durationHours Int           @map("duration_hours")
  status        RequestStatus @default(PENDING)
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relationships
  customer Customer      @relation("CustomerRequests", fields: [customerId], references: [id])
  vehicle  Vehicle       @relation(fields: [vehicleId], references: [id])
  zone     ParkingZone?  @relation(fields: [zoneId], references: [id])
  bay      ParkingBay?   @relation(fields: [bayId], references: [id])
  slot     ParkingSlot?  @relation(fields: [slotId], references: [id])

  @@map("parking_requests")
}
